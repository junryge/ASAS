<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK Hynix 3D Campus Map Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0e1a; --card: #111827; --border: #1e293b;
            --text: #e2e8f0; --muted: #64748b; --blue: #3b82f6;
            --cyan: #06b6d4; --purple: #8b5cf6; --amber: #f59e0b;
            --emerald: #10b981; --rose: #f43f5e; --orange: #f97316;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

        /* 레이아웃 */
        .app { display: grid; grid-template-columns: 280px 1fr 300px; grid-template-rows: 56px 1fr; height: 100vh; }

        /* 헤더 */
        .header {
            grid-column: 1 / -1; background: rgba(17,24,39,0.95);
            border-bottom: 1px solid var(--border); padding: 0 20px;
            display: flex; align-items: center; gap: 16px;
            backdrop-filter: blur(12px); z-index: 100;
        }
        .header h1 {
            font-size: 1.2rem; font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header .badge {
            padding: 3px 10px; background: rgba(59,130,246,0.15);
            border: 1px solid rgba(59,130,246,0.3); border-radius: 10px;
            font-size: 10px; color: var(--blue); font-family: 'JetBrains Mono', monospace;
        }

        /* 좌측 패널 - 빌딩 목록 */
        .left-panel {
            background: var(--card); border-right: 1px solid var(--border);
            overflow-y: auto; padding: 16px;
        }
        .panel-title { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }

        .building-item {
            padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid var(--border);
            border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .building-item:hover { border-color: var(--blue); background: rgba(59,130,246,0.05); }
        .building-item.selected { border-color: var(--blue); background: rgba(59,130,246,0.1); }
        .building-item .name { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .building-item .info { font-size: 11px; color: var(--muted); }
        .building-item .color-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        .add-btn {
            width: 100%; padding: 10px; background: rgba(59,130,246,0.1);
            border: 1px dashed var(--blue); border-radius: 10px; color: var(--blue);
            font-size: 13px; cursor: pointer; text-align: center; margin-top: 8px; transition: all 0.2s;
        }
        .add-btn:hover { background: rgba(59,130,246,0.2); }

        /* 중앙 - 3D 뷰포트 */
        .viewport { position: relative; overflow: hidden; background: #080c16; }
        #canvas3d { width: 100%; height: 100%; display: block; }
        .viewport-controls {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 10;
        }
        .ctrl-btn {
            padding: 8px 16px; background: rgba(17,24,39,0.9); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-size: 12px; cursor: pointer; transition: all 0.2s;
            backdrop-filter: blur(8px);
        }
        .ctrl-btn:hover { border-color: var(--blue); background: rgba(59,130,246,0.15); }
        .ctrl-btn.active { border-color: var(--blue); color: var(--blue); }

        .viewport-info {
            position: absolute; top: 16px; left: 16px; z-index: 10;
            padding: 10px 16px; background: rgba(17,24,39,0.9); border: 1px solid var(--border);
            border-radius: 10px; font-size: 11px; color: var(--muted);
            font-family: 'JetBrains Mono', monospace; backdrop-filter: blur(8px);
        }

        /* 우측 패널 - 속성 편집 */
        .right-panel {
            background: var(--card); border-left: 1px solid var(--border);
            overflow-y: auto; padding: 16px;
        }
        .prop-group { margin-bottom: 16px; }
        .prop-group label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 4px; }
        .prop-group input, .prop-group select {
            width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.04);
            border: 1px solid var(--border); border-radius: 8px; color: var(--text);
            font-size: 12px; font-family: 'JetBrains Mono', monospace;
        }
        .prop-group input:focus { outline: none; border-color: var(--blue); }
        .prop-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .prop-row label { grid-column: 1 / -1; }

        .color-picker-row { display: flex; gap: 8px; align-items: center; }
        .color-picker-row input[type="color"] {
            width: 36px; height: 36px; border: none; border-radius: 8px; cursor: pointer;
            background: none; padding: 0;
        }

        .action-btn {
            width: 100%; padding: 10px; border-radius: 10px; font-size: 13px;
            font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif; margin-bottom: 8px;
        }
        .action-btn.primary { background: var(--blue); color: white; }
        .action-btn.primary:hover { background: #2563eb; }
        .action-btn.success { background: var(--emerald); color: white; }
        .action-btn.success:hover { background: #059669; }
        .action-btn.secondary { background: rgba(255,255,255,0.06); color: var(--text); border: 1px solid var(--border); }
        .action-btn.secondary:hover { background: rgba(255,255,255,0.1); }
        .action-btn.amber { background: var(--amber); color: #000; }

        .section-divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

        /* 토스트 */
        .toast {
            position: fixed; bottom: 24px; right: 24px; padding: 14px 24px;
            background: var(--emerald); color: white; border-radius: 12px;
            font-size: 14px; font-weight: 500; z-index: 999;
            transform: translateY(100px); opacity: 0; transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* 3D 라벨 */
        .label-3d {
            position: absolute; padding: 4px 10px; background: rgba(0,0,0,0.8);
            border: 1px solid var(--border); border-radius: 6px; font-size: 11px;
            color: var(--text); font-family: 'JetBrains Mono', monospace;
            pointer-events: none; white-space: nowrap; transform: translate(-50%, -100%);
            z-index: 50;
        }
    </style>
</head>
<body>

<div class="app">
    <!-- 헤더 -->
    <div class="header">
        <h1>3D Campus Map Tool</h1>
        <div class="badge">Three.js</div>
        <div style="flex:1"></div>
        <div style="font-size:12px;color:var(--muted);">
            마우스: 회전 | 스크롤: 줌 | Shift+드래그: 이동
        </div>
    </div>

    <!-- 좌측: 빌딩 목록 -->
    <div class="left-panel">
        <div class="panel-title">빌딩 목록</div>
        <div id="buildingList"></div>
        <div class="add-btn" onclick="addBuilding()">+ 빌딩 추가</div>

        <hr class="section-divider">
        <div class="panel-title">프리셋</div>
        <div class="add-btn" onclick="loadPreset('hynix_icheon')" style="margin-bottom:6px;">SK Hynix 이천 캠퍼스</div>
        <div class="add-btn" onclick="loadPreset('hynix_cheongju')" style="margin-bottom:6px;">SK Hynix 청주 캠퍼스</div>
        <div class="add-btn" onclick="loadPreset('simple_fab')">기본 FAB 레이아웃</div>

        <hr class="section-divider">
        <div class="panel-title">내보내기</div>
        <button class="action-btn primary" onclick="exportHTML()">HTML 내보내기</button>
        <button class="action-btn success" onclick="exportJSON()">JSON 내보내기</button>
        <button class="action-btn secondary" onclick="importJSON()">JSON 가져오기</button>
        <input type="file" id="importInput" accept=".json" style="display:none" onchange="handleImport(event)">
    </div>

    <!-- 중앙: 3D 뷰포트 -->
    <div class="viewport">
        <canvas id="canvas3d"></canvas>
        <div class="viewport-info" id="viewInfo">빌딩 0개 | 카메라: (0, 0, 0)</div>
        <div class="viewport-controls">
            <div class="ctrl-btn active" onclick="setView('perspective')">퍼스펙티브</div>
            <div class="ctrl-btn" onclick="setView('top')">탑뷰</div>
            <div class="ctrl-btn" onclick="setView('front')">정면</div>
            <div class="ctrl-btn" onclick="setView('side')">측면</div>
            <div class="ctrl-btn" onclick="toggleGrid()">그리드</div>
            <div class="ctrl-btn" onclick="toggleLabels()">라벨</div>
            <div class="ctrl-btn" onclick="resetCamera()">리셋</div>
        </div>
        <div id="labels3d"></div>
    </div>

    <!-- 우측: 속성 편집 -->
    <div class="right-panel">
        <div class="panel-title">속성 편집</div>
        <div id="propsPanel">
            <div style="color:var(--muted);font-size:13px;text-align:center;padding:40px 0;">
                빌딩을 선택하면 속성을 편집할 수 있습니다
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- Three.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
// ===== 전역 상태 =====
let scene, camera, renderer, raycaster, mouse;
let buildings = [];
let selectedBuilding = null;
let gridHelper, groundMesh;
let showLabels = true;
let showGrid = true;
let isDragging = false, prevMouse = { x: 0, y: 0 };
let cameraTarget = { x: 0, y: 0, z: 0 };
let cameraAngle = { theta: Math.PI / 4, phi: Math.PI / 3, distance: 80 };

const BUILDING_COLORS = [
    '#3b82f6', '#06b6d4', '#8b5cf6', '#f59e0b', '#10b981',
    '#f43f5e', '#f97316', '#0ea5e9', '#a78bfa', '#34d399',
    '#fb923c', '#94a3b8', '#ec4899', '#14b8a6', '#eab308'
];

// ===== 초기화 =====
function init() {
    const canvas = document.getElementById('canvas3d');
    const viewport = canvas.parentElement;

    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x080c16);
    scene.fog = new THREE.FogExp2(0x080c16, 0.003);

    // Camera
    camera = new THREE.PerspectiveCamera(60, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
    updateCameraPosition();

    // Renderer
    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(viewport.clientWidth, viewport.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // Lights
    const ambientLight = new THREE.AmbientLight(0x404060, 0.6);
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(50, 80, 50);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;
    dirLight.shadow.camera.near = 0.5;
    dirLight.shadow.camera.far = 200;
    dirLight.shadow.camera.left = -100;
    dirLight.shadow.camera.right = 100;
    dirLight.shadow.camera.top = 100;
    dirLight.shadow.camera.bottom = -100;
    scene.add(dirLight);

    const hemiLight = new THREE.HemisphereLight(0x3b82f6, 0x0a0e1a, 0.3);
    scene.add(hemiLight);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(200, 200);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x0d1117, roughness: 0.9 });
    groundMesh = new THREE.Mesh(groundGeo, groundMat);
    groundMesh.rotation.x = -Math.PI / 2;
    groundMesh.receiveShadow = true;
    scene.add(groundMesh);

    // Grid
    gridHelper = new THREE.GridHelper(200, 40, 0x1a2744, 0x111827);
    gridHelper.position.y = 0.01;
    scene.add(gridHelper);

    // Raycaster
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    // 이벤트
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onWheel);
    canvas.addEventListener('click', onClick);
    canvas.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('resize', onResize);

    // 기본 프리셋 로드
    loadPreset('hynix_icheon');

    animate();
}

// ===== 카메라 =====
function updateCameraPosition() {
    const { theta, phi, distance } = cameraAngle;
    camera.position.x = cameraTarget.x + distance * Math.sin(phi) * Math.cos(theta);
    camera.position.y = cameraTarget.y + distance * Math.cos(phi);
    camera.position.z = cameraTarget.z + distance * Math.sin(phi) * Math.sin(theta);
    camera.lookAt(cameraTarget.x, cameraTarget.y, cameraTarget.z);
}

function setView(type) {
    document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    switch(type) {
        case 'perspective':
            cameraAngle = { theta: Math.PI / 4, phi: Math.PI / 3, distance: 80 };
            break;
        case 'top':
            cameraAngle = { theta: 0, phi: 0.01, distance: 100 };
            break;
        case 'front':
            cameraAngle = { theta: 0, phi: Math.PI / 2, distance: 80 };
            break;
        case 'side':
            cameraAngle = { theta: Math.PI / 2, phi: Math.PI / 2, distance: 80 };
            break;
    }
    updateCameraPosition();
}

function resetCamera() {
    cameraTarget = { x: 0, y: 0, z: 0 };
    cameraAngle = { theta: Math.PI / 4, phi: Math.PI / 3, distance: 80 };
    updateCameraPosition();
}

// ===== 마우스 이벤트 =====
function onMouseDown(e) {
    isDragging = true;
    prevMouse = { x: e.clientX, y: e.clientY };
}

function onMouseMove(e) {
    if (!isDragging) return;
    const dx = e.clientX - prevMouse.x;
    const dy = e.clientY - prevMouse.y;

    if (e.shiftKey || e.button === 2) {
        // 이동
        const right = new THREE.Vector3();
        const up = new THREE.Vector3(0, 1, 0);
        camera.getWorldDirection(right);
        right.cross(up).normalize();
        cameraTarget.x -= (dx * right.x + dy * up.x) * 0.1;
        cameraTarget.y += dy * 0.05;
        cameraTarget.z -= (dx * right.z + dy * up.z) * 0.1;
    } else {
        // 회전
        cameraAngle.theta -= dx * 0.005;
        cameraAngle.phi = Math.max(0.1, Math.min(Math.PI / 2 - 0.01, cameraAngle.phi - dy * 0.005));
    }

    prevMouse = { x: e.clientX, y: e.clientY };
    updateCameraPosition();
}

function onMouseUp() { isDragging = false; }

function onWheel(e) {
    e.preventDefault();
    cameraAngle.distance = Math.max(10, Math.min(200, cameraAngle.distance + e.deltaY * 0.05));
    updateCameraPosition();
}

function onClick(e) {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const meshes = buildings.map(b => b.mesh).filter(Boolean);
    const intersects = raycaster.intersectObjects(meshes);

    if (intersects.length > 0) {
        const building = buildings.find(b => b.mesh === intersects[0].object);
        if (building) selectBuilding(building);
    }
}

function onResize() {
    const viewport = document.getElementById('canvas3d').parentElement;
    camera.aspect = viewport.clientWidth / viewport.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(viewport.clientWidth, viewport.clientHeight);
}

// ===== 빌딩 관리 =====
function addBuilding(data = null) {
    const id = 'bldg_' + Date.now();
    const colorIdx = buildings.length % BUILDING_COLORS.length;
    const building = {
        id,
        name: data?.name || `Building ${buildings.length + 1}`,
        type: data?.type || 'fab',
        x: data?.x || 0,
        y: data?.y || 0,
        z: data?.z || 0,
        width: data?.width || 20,
        height: data?.height || 8,
        depth: data?.depth || 15,
        color: data?.color || BUILDING_COLORS[colorIdx],
        floors: data?.floors || 3,
        description: data?.description || '',
        mesh: null,
        label: null,
    };

    createBuildingMesh(building);
    buildings.push(building);
    renderBuildingList();
    updateViewInfo();
    return building;
}

function createBuildingMesh(building) {
    if (building.mesh) {
        scene.remove(building.mesh);
        if (building.wireframe) scene.remove(building.wireframe);
    }

    const geo = new THREE.BoxGeometry(building.width, building.height, building.depth);
    const color = new THREE.Color(building.color);
    const mat = new THREE.MeshStandardMaterial({
        color: color,
        roughness: 0.4,
        metalness: 0.1,
        transparent: true,
        opacity: 0.85,
    });

    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(building.x, building.height / 2 + building.y, building.z);
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    scene.add(mesh);
    building.mesh = mesh;

    // 와이어프레임
    const wireGeo = new THREE.EdgesGeometry(geo);
    const wireMat = new THREE.LineBasicMaterial({ color: color.clone().multiplyScalar(1.5), transparent: true, opacity: 0.6 });
    const wireframe = new THREE.LineSegments(wireGeo, wireMat);
    wireframe.position.copy(mesh.position);
    scene.add(wireframe);
    building.wireframe = wireframe;

    // 층 표시 라인
    if (building.floors > 1) {
        const floorHeight = building.height / building.floors;
        for (let i = 1; i < building.floors; i++) {
            const lineGeo = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(-building.width/2, -building.height/2 + i*floorHeight, -building.depth/2),
                new THREE.Vector3(building.width/2, -building.height/2 + i*floorHeight, -building.depth/2),
                new THREE.Vector3(building.width/2, -building.height/2 + i*floorHeight, building.depth/2),
                new THREE.Vector3(-building.width/2, -building.height/2 + i*floorHeight, building.depth/2),
                new THREE.Vector3(-building.width/2, -building.height/2 + i*floorHeight, -building.depth/2),
            ]);
            const lineMat = new THREE.LineBasicMaterial({ color: 0x334155, transparent: true, opacity: 0.4 });
            const line = new THREE.Line(lineGeo, lineMat);
            line.position.copy(mesh.position);
            scene.add(line);
        }
    }
}

function removeBuilding(id) {
    const idx = buildings.findIndex(b => b.id === id);
    if (idx < 0) return;
    const b = buildings[idx];
    if (b.mesh) scene.remove(b.mesh);
    if (b.wireframe) scene.remove(b.wireframe);
    buildings.splice(idx, 1);
    if (selectedBuilding?.id === id) { selectedBuilding = null; renderPropsPanel(); }
    renderBuildingList();
    updateViewInfo();
}

function selectBuilding(building) {
    selectedBuilding = building;
    renderBuildingList();
    renderPropsPanel();

    // 하이라이트
    buildings.forEach(b => {
        if (b.mesh) b.mesh.material.opacity = b.id === building.id ? 1.0 : 0.6;
    });
}

// ===== UI 렌더링 =====
function renderBuildingList() {
    const container = document.getElementById('buildingList');
    container.innerHTML = buildings.map(b => `
        <div class="building-item ${selectedBuilding?.id === b.id ? 'selected' : ''}" onclick="selectBuilding(buildings.find(x=>x.id==='${b.id}'))">
            <div class="name"><span class="color-dot" style="background:${b.color}"></span>${b.name}</div>
            <div class="info">${b.type} | ${b.width}x${b.depth}x${b.height} | ${b.floors}F</div>
        </div>
    `).join('');
}

function renderPropsPanel() {
    const panel = document.getElementById('propsPanel');
    if (!selectedBuilding) {
        panel.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:40px 0;">빌딩을 선택하세요</div>';
        return;
    }
    const b = selectedBuilding;
    panel.innerHTML = `
        <div class="prop-group">
            <label>이름</label>
            <input type="text" value="${b.name}" onchange="updateProp('name', this.value)">
        </div>
        <div class="prop-group">
            <label>유형</label>
            <select onchange="updateProp('type', this.value)">
                <option value="fab" ${b.type==='fab'?'selected':''}>FAB (제조동)</option>
                <option value="office" ${b.type==='office'?'selected':''}>사무동</option>
                <option value="hub" ${b.type==='hub'?'selected':''}>HUB (물류)</option>
                <option value="cleanroom" ${b.type==='cleanroom'?'selected':''}>클린룸</option>
                <option value="utility" ${b.type==='utility'?'selected':''}>유틸리티</option>
                <option value="parking" ${b.type==='parking'?'selected':''}>주차장</option>
                <option value="other" ${b.type==='other'?'selected':''}>기타</option>
            </select>
        </div>
        <div class="prop-group">
            <label>색상</label>
            <div class="color-picker-row">
                <input type="color" value="${b.color}" onchange="updateProp('color', this.value)">
                <input type="text" value="${b.color}" style="flex:1" onchange="updateProp('color', this.value)">
            </div>
        </div>
        <hr class="section-divider">
        <div class="prop-group">
            <label>위치 (X, Y, Z)</label>
            <div class="prop-row">
                <input type="number" value="${b.x}" step="1" onchange="updateProp('x', parseFloat(this.value))">
                <input type="number" value="${b.y}" step="0.5" onchange="updateProp('y', parseFloat(this.value))">
                <input type="number" value="${b.z}" step="1" onchange="updateProp('z', parseFloat(this.value))">
            </div>
        </div>
        <div class="prop-group">
            <label>크기 (너비, 높이, 깊이)</label>
            <div class="prop-row">
                <input type="number" value="${b.width}" min="1" step="1" onchange="updateProp('width', parseFloat(this.value))">
                <input type="number" value="${b.height}" min="1" step="0.5" onchange="updateProp('height', parseFloat(this.value))">
                <input type="number" value="${b.depth}" min="1" step="1" onchange="updateProp('depth', parseFloat(this.value))">
            </div>
        </div>
        <div class="prop-group">
            <label>층수</label>
            <input type="number" value="${b.floors}" min="1" max="20" onchange="updateProp('floors', parseInt(this.value))">
        </div>
        <div class="prop-group">
            <label>설명</label>
            <input type="text" value="${b.description}" onchange="updateProp('description', this.value)">
        </div>
        <hr class="section-divider">
        <button class="action-btn secondary" onclick="duplicateBuilding()">복제</button>
        <button class="action-btn" style="background:var(--rose);color:white;" onclick="removeBuilding('${b.id}')">삭제</button>
    `;
}

function updateProp(key, value) {
    if (!selectedBuilding) return;
    selectedBuilding[key] = value;

    if (['width','height','depth','color','x','y','z','floors'].includes(key)) {
        createBuildingMesh(selectedBuilding);
    }
    renderBuildingList();
    renderPropsPanel();
}

function duplicateBuilding() {
    if (!selectedBuilding) return;
    const b = selectedBuilding;
    addBuilding({ ...b, name: b.name + ' (복사)', x: b.x + b.width + 5 });
}

function updateViewInfo() {
    const info = document.getElementById('viewInfo');
    const pos = camera.position;
    info.textContent = `빌딩 ${buildings.length}개 | 카메라: (${pos.x.toFixed(0)}, ${pos.y.toFixed(0)}, ${pos.z.toFixed(0)})`;
}

function toggleGrid() {
    showGrid = !showGrid;
    gridHelper.visible = showGrid;
    event.target.classList.toggle('active', showGrid);
}

function toggleLabels() {
    showLabels = !showLabels;
    event.target.classList.toggle('active', showLabels);
}

// ===== 프리셋 =====
function loadPreset(name) {
    // 기존 빌딩 모두 제거
    [...buildings].forEach(b => removeBuilding(b.id));

    const presets = {
        hynix_icheon: [
            { name: 'M10', type: 'fab', x: -40, z: -20, width: 25, depth: 18, height: 10, floors: 4, color: '#3b82f6', description: 'M10 FAB' },
            { name: 'M11', type: 'fab', x: -10, z: -20, width: 25, depth: 18, height: 10, floors: 4, color: '#06b6d4', description: 'M11 FAB' },
            { name: 'M14', type: 'fab', x: 20, z: -20, width: 30, depth: 20, height: 12, floors: 5, color: '#8b5cf6', description: 'M14 FAB - 510 컬럼' },
            { name: 'M15', type: 'fab', x: 55, z: -20, width: 28, depth: 18, height: 11, floors: 4, color: '#f59e0b', description: 'M15 FAB' },
            { name: 'M16 HUB', type: 'hub', x: 20, z: 8, width: 18, depth: 12, height: 8, floors: 3, color: '#f97316', description: 'M16HUB - 336 컬럼' },
            { name: 'M16A', type: 'fab', x: -5, z: 25, width: 22, depth: 16, height: 10, floors: 4, color: '#10b981', description: 'M16A FAB' },
            { name: 'M16E', type: 'fab', x: 45, z: 25, width: 22, depth: 16, height: 10, floors: 4, color: '#14b8a6', description: 'M16E FAB' },
            { name: 'R&D Center', type: 'office', x: -45, z: 25, width: 20, depth: 14, height: 6, floors: 3, color: '#94a3b8', description: '연구개발센터' },
            { name: 'Utility', type: 'utility', x: 70, z: 10, width: 12, depth: 10, height: 5, floors: 2, color: '#64748b', description: '유틸리티 동' },
        ],
        hynix_cheongju: [
            { name: 'C2', type: 'fab', x: -25, z: -15, width: 28, depth: 20, height: 12, floors: 5, color: '#3b82f6', description: 'C2 FAB' },
            { name: 'C2F', type: 'fab', x: 10, z: -15, width: 28, depth: 20, height: 12, floors: 5, color: '#06b6d4', description: 'C2F FAB' },
            { name: 'C3', type: 'fab', x: -25, z: 15, width: 30, depth: 22, height: 14, floors: 5, color: '#8b5cf6', description: 'C3 FAB (신축)' },
            { name: 'CJ PKG', type: 'fab', x: 10, z: 15, width: 24, depth: 18, height: 10, floors: 4, color: '#f59e0b', description: '청주 패키징' },
            { name: 'CJ PRB', type: 'fab', x: 40, z: 0, width: 20, depth: 16, height: 9, floors: 3, color: '#10b981', description: '청주 프로브' },
        ],
        simple_fab: [
            { name: 'FAB A', type: 'fab', x: -20, z: 0, width: 25, depth: 18, height: 10, floors: 4, color: '#3b82f6', description: 'Main FAB' },
            { name: 'FAB B', type: 'fab', x: 20, z: 0, width: 25, depth: 18, height: 10, floors: 4, color: '#06b6d4', description: 'Sub FAB' },
            { name: 'HUB', type: 'hub', x: 0, z: -18, width: 15, depth: 10, height: 6, floors: 2, color: '#f59e0b', description: 'AMHS Hub' },
        ],
    };

    (presets[name] || presets.simple_fab).forEach(d => addBuilding(d));
    resetCamera();
    showToast(`프리셋 로드: ${name}`);
}

// ===== 내보내기 =====
function exportJSON() {
    const data = {
        version: '1.0',
        name: 'SK Hynix 3D Campus',
        buildings: buildings.map(b => ({
            name: b.name, type: b.type,
            x: b.x, y: b.y, z: b.z,
            width: b.width, height: b.height, depth: b.depth,
            color: b.color, floors: b.floors, description: b.description,
        })),
        camera: { ...cameraAngle, target: cameraTarget },
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'SK_Hynix_3D_Campus.json';
    a.click(); URL.revokeObjectURL(url);
    showToast('JSON 내보내기 완료');
}

function exportHTML() {
    // 현재 상태를 독립형 HTML로 내보내기
    const buildingData = buildings.map(b => ({
        name: b.name, type: b.type,
        x: b.x, y: b.y, z: b.z,
        width: b.width, height: b.height, depth: b.depth,
        color: b.color, floors: b.floors, description: b.description,
    }));

    const html = generateStandaloneHTML(buildingData);
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'SK_Hynix_3D_Campus_0.4V.HTML';
    a.click(); URL.revokeObjectURL(url);
    showToast('HTML 내보내기 완료');
}

function generateStandaloneHTML(buildingData) {
    return `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SK Hynix 3D Campus Map</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;background:#080c16;color:#e2e8f0;overflow:hidden;height:100vh}
#info{position:absolute;top:16px;left:16px;padding:12px 20px;background:rgba(17,24,39,0.9);border:1px solid #1e293b;border-radius:12px;font-size:12px;z-index:10;backdrop-filter:blur(8px)}
#info h2{font-size:16px;background:linear-gradient(135deg,#3b82f6,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
#info p{color:#64748b;font-size:11px}
#legend{position:absolute;bottom:16px;left:16px;padding:12px 16px;background:rgba(17,24,39,0.9);border:1px solid #1e293b;border-radius:12px;font-size:11px;z-index:10;max-width:250px}
.leg-item{display:flex;align-items:center;gap:8px;padding:3px 0}
.leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
#controls{position:absolute;bottom:16px;right:16px;display:flex;gap:6px;z-index:10}
#controls button{padding:8px 14px;background:rgba(17,24,39,0.9);border:1px solid #1e293b;border-radius:8px;color:#e2e8f0;font-size:11px;cursor:pointer}
#controls button:hover{border-color:#3b82f6}
canvas{display:block}
</style>
</head>
<body>
<div id="info"><h2>SK Hynix 3D Campus</h2><p>마우스: 회전 | 스크롤: 줌 | Shift+드래그: 이동</p></div>
<div id="legend"></div>
<div id="controls">
<button onclick="sv('p')">퍼스펙티브</button>
<button onclick="sv('t')">탑뷰</button>
<button onclick="sv('f')">정면</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
<script>
const B=${JSON.stringify(buildingData)};
let s,c,r,a={theta:Math.PI/4,phi:Math.PI/3,d:80},t={x:0,y:0,z:0},dr=false,pm={x:0,y:0};
function init(){
s=new THREE.Scene();s.background=new THREE.Color(0x080c16);s.fog=new THREE.FogExp2(0x080c16,0.003);
c=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
r=new THREE.WebGLRenderer({antialias:true});r.setSize(innerWidth,innerHeight);r.setPixelRatio(devicePixelRatio);
r.shadowMap.enabled=true;document.body.appendChild(r.domElement);
s.add(new THREE.AmbientLight(0x404060,0.6));
const dl=new THREE.DirectionalLight(0xffffff,0.8);dl.position.set(50,80,50);dl.castShadow=true;s.add(dl);
s.add(new THREE.HemisphereLight(0x3b82f6,0x0a0e1a,0.3));
const g=new THREE.Mesh(new THREE.PlaneGeometry(200,200),new THREE.MeshStandardMaterial({color:0x0d1117}));
g.rotation.x=-Math.PI/2;g.receiveShadow=true;s.add(g);
s.add(new THREE.GridHelper(200,40,0x1a2744,0x111827));
let leg='';
B.forEach(b=>{
const geo=new THREE.BoxGeometry(b.width,b.height,b.depth);
const mat=new THREE.MeshStandardMaterial({color:b.color,roughness:0.4,metalness:0.1,transparent:true,opacity:0.85});
const m=new THREE.Mesh(geo,mat);m.position.set(b.x,b.height/2+(b.y||0),b.z);m.castShadow=true;s.add(m);
const eg=new THREE.EdgesGeometry(geo);
const wf=new THREE.LineSegments(eg,new THREE.LineBasicMaterial({color:new THREE.Color(b.color).multiplyScalar(1.5),opacity:0.6,transparent:true}));
wf.position.copy(m.position);s.add(wf);
leg+='<div class="leg-item"><div class="leg-dot" style="background:'+b.color+'"></div>'+b.name+(b.description?' - '+b.description:'')+'</div>';
});
document.getElementById('legend').innerHTML=leg;
uc();
r.domElement.addEventListener('mousedown',e=>{dr=true;pm={x:e.clientX,y:e.clientY}});
r.domElement.addEventListener('mousemove',e=>{if(!dr)return;const dx=e.clientX-pm.x,dy=e.clientY-pm.y;
if(e.shiftKey){const rv=new THREE.Vector3();c.getWorldDirection(rv);rv.cross(new THREE.Vector3(0,1,0)).normalize();
t.x-=dx*rv.x*0.1;t.z-=dx*rv.z*0.1;t.y+=dy*0.05;}else{a.theta-=dx*0.005;a.phi=Math.max(0.1,Math.min(1.56,a.phi-dy*0.005));}
pm={x:e.clientX,y:e.clientY};uc();});
r.domElement.addEventListener('mouseup',()=>dr=false);
r.domElement.addEventListener('wheel',e=>{e.preventDefault();a.d=Math.max(10,Math.min(200,a.d+e.deltaY*0.05));uc();});
window.addEventListener('resize',()=>{c.aspect=innerWidth/innerHeight;c.updateProjectionMatrix();r.setSize(innerWidth,innerHeight);});
(function an(){requestAnimationFrame(an);r.render(s,c)})();
}
function uc(){c.position.set(t.x+a.d*Math.sin(a.phi)*Math.cos(a.theta),t.y+a.d*Math.cos(a.phi),t.z+a.d*Math.sin(a.phi)*Math.sin(a.theta));c.lookAt(t.x,t.y,t.z);}
function sv(v){if(v==='t')a={theta:0,phi:0.01,d:100};else if(v==='f')a={theta:0,phi:Math.PI/2,d:80};else a={theta:Math.PI/4,phi:Math.PI/3,d:80};uc();}
init();
<\/script>
</body>
</html>`;
}

function importJSON() { document.getElementById('importInput').click(); }

function handleImport(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const data = JSON.parse(ev.target.result);
            [...buildings].forEach(b => removeBuilding(b.id));
            (data.buildings || []).forEach(d => addBuilding(d));
            if (data.camera) {
                cameraAngle = { theta: data.camera.theta, phi: data.camera.phi, distance: data.camera.distance };
                if (data.camera.target) cameraTarget = data.camera.target;
                updateCameraPosition();
            }
            showToast('JSON 가져오기 완료');
        } catch(err) { showToast('JSON 파싱 에러: ' + err.message); }
    };
    reader.readAsText(file);
}

// ===== 3D 라벨 =====
function updateLabels() {
    const container = document.getElementById('labels3d');
    if (!showLabels) { container.innerHTML = ''; return; }

    let html = '';
    buildings.forEach(b => {
        if (!b.mesh) return;
        const pos = b.mesh.position.clone();
        pos.y += b.height / 2 + 1;
        pos.project(camera);

        const canvas = renderer.domElement;
        const x = (pos.x * 0.5 + 0.5) * canvas.clientWidth;
        const y = (-pos.y * 0.5 + 0.5) * canvas.clientHeight;

        if (pos.z < 1 && x > 0 && x < canvas.clientWidth && y > 0 && y < canvas.clientHeight) {
            html += `<div class="label-3d" style="left:${x}px;top:${y}px;border-color:${b.color}40;">
                <span style="color:${b.color}">${b.name}</span>
            </div>`;
        }
    });
    container.innerHTML = html;
}

// ===== 애니메이션 루프 =====
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
    updateLabels();
    updateViewInfo();
}

// ===== 유틸 =====
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

// 시작
init();
</script>
</body>
</html>
