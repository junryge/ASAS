<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHT2 Simulator - M14 Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: 320px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }

        .sidebar h1 {
            font-size: 1.4em;
            color: #00d9ff;
            margin-bottom: 5px;
        }

        .sidebar .subtitle {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 20px;
        }

        .panel {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .panel h3 {
            font-size: 0.95em;
            color: #00d9ff;
            margin-bottom: 12px;
            border-bottom: 1px solid #1a4080;
            padding-bottom: 8px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-item .label {
            font-size: 0.75em;
            color: #888;
            margin-top: 3px;
        }

        /* 컨트롤 버튼 */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-start {
            background: #00d9ff;
            color: #1a1a2e;
        }

        .btn-start:hover {
            background: #00b8d9;
        }

        .btn-pause {
            background: #ffc107;
            color: #1a1a2e;
        }

        .btn-stop {
            background: #ff5252;
            color: white;
        }

        .btn-job {
            background: #4caf50;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 차량 목록 */
        .vehicle-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .vehicle-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #1a1a2e;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .vehicle-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
        }

        .vehicle-icon.idle { background: #4caf50; }
        .vehicle-icon.moving { background: #00d9ff; }
        .vehicle-icon.loading { background: #ffc107; }
        .vehicle-icon.unloading { background: #ff9800; }
        .vehicle-icon.error { background: #ff5252; }

        .vehicle-info {
            flex: 1;
        }

        .vehicle-info .name {
            font-weight: bold;
        }

        .vehicle-info .status {
            font-size: 0.8em;
            color: #888;
        }

        /* 메인 캔버스 영역 */
        .main-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #canvas {
            background: #0d1b2a;
            cursor: grab;
        }

        #canvas:active {
            cursor: grabbing;
        }

        /* 줌 컨트롤 */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 5px;
            color: #00d9ff;
            font-size: 1.5em;
            cursor: pointer;
        }

        .zoom-btn:hover {
            background: #0f3460;
        }

        /* 정보 오버레이 */
        .info-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.9);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
        }

        .info-overlay .time {
            font-size: 1.2em;
            color: #00d9ff;
            font-weight: bold;
        }

        /* 범례 */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.9);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.8em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
        }

        /* 스크롤바 스타일 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #0f3460;
            border-radius: 3px;
        }

        /* 작업 폼 */
        .job-form {
            display: grid;
            gap: 10px;
        }

        .job-form label {
            font-size: 0.85em;
            color: #888;
        }

        .job-form input, .job-form select {
            padding: 8px;
            background: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 5px;
            color: #eee;
        }

        .job-form input:focus, .job-form select:focus {
            outline: none;
            border-color: #00d9ff;
        }

        /* 로그 패널 */
        .log-panel {
            background: #0d1b2a;
            border-radius: 5px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.75em;
        }

        .log-entry {
            margin-bottom: 3px;
            padding: 2px 5px;
        }

        .log-entry.info { color: #00d9ff; }
        .log-entry.success { color: #4caf50; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.error { color: #ff5252; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <h1>OHT2 Simulator</h1>
            <p class="subtitle">M14-Pro Ver.1.22.2 | SK Hynix</p>

            <!-- 컨트롤 -->
            <div class="controls">
                <button class="btn btn-start" id="btnStart" onclick="startSimulation()">Start</button>
                <button class="btn btn-pause" id="btnPause" onclick="pauseSimulation()" disabled>Pause</button>
                <button class="btn btn-stop" id="btnStop" onclick="stopSimulation()" disabled>Stop</button>
            </div>

            <!-- 통계 -->
            <div class="panel">
                <h3>System Status</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="value" id="statVehicles">0</div>
                        <div class="label">Vehicles</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="statStations">0</div>
                        <div class="label">Stations</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="statActiveJobs">0</div>
                        <div class="label">Active Jobs</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="statCompletedJobs">0</div>
                        <div class="label">Completed</div>
                    </div>
                </div>
            </div>

            <!-- 작업 생성 -->
            <div class="panel">
                <h3>Create Transport Job</h3>
                <div class="job-form">
                    <div>
                        <label>Source Station</label>
                        <input type="number" id="sourceStation" value="1" min="1">
                    </div>
                    <div>
                        <label>Destination Station</label>
                        <input type="number" id="destStation" value="10" min="1">
                    </div>
                    <div>
                        <label>Priority</label>
                        <select id="jobPriority">
                            <option value="NORMAL">Normal</option>
                            <option value="HIGH">High</option>
                            <option value="URGENT">Urgent</option>
                            <option value="HOTLOT">HotLot (Priority 99)</option>
                        </select>
                    </div>
                    <button class="btn btn-job" onclick="createJob()">Create Job</button>
                </div>
            </div>

            <!-- 차량 목록 -->
            <div class="panel">
                <h3>Vehicle Status</h3>
                <div class="vehicle-list" id="vehicleList">
                    <!-- 동적으로 채워짐 -->
                </div>
            </div>

            <!-- 로그 -->
            <div class="panel">
                <h3>Event Log</h3>
                <div class="log-panel" id="logPanel">
                    <!-- 동적으로 채워짐 -->
                </div>
            </div>
        </div>

        <!-- 메인 캔버스 영역 -->
        <div class="main-area">
            <canvas id="canvas"></canvas>

            <!-- 정보 오버레이 -->
            <div class="info-overlay">
                <div class="time" id="simTime">00:00:00</div>
                <div>Tick: <span id="tickCount">0</span></div>
                <div>Speed: <span id="simSpeed">1x</span></div>
            </div>

            <!-- 범례 -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>Idle Vehicle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00d9ff;"></div>
                    <span>Moving Vehicle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <span>Loading/Unloading</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196f3;"></div>
                    <span>Station (Available)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>Station (Has FOUP)</span>
                </div>
            </div>

            <!-- 줌 컨트롤 -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">-</button>
                <button class="zoom-btn" onclick="resetView()">R</button>
            </div>
        </div>
    </div>

    <script>
        // 캔버스 설정
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 시뮬레이션 상태
        let isRunning = false;
        let isPaused = false;
        let tick = 0;
        let simTime = 0;

        // 뷰 설정
        let scale = 0.1;
        let offsetX = 50;
        let offsetY = 50;
        let isDragging = false;
        let lastMouseX, lastMouseY;

        // 데이터
        let vehicles = [];
        let stations = [];
        let addresses = [];
        let lanes = [];

        // 웹소켓 (서버 연결 시)
        let ws = null;

        // 초기화
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // 캔버스 이벤트
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', drag);
            canvas.addEventListener('mouseup', endDrag);
            canvas.addEventListener('mouseleave', endDrag);
            canvas.addEventListener('wheel', handleZoom);

            // 데모 데이터 생성
            generateDemoData();

            // 렌더링 시작
            render();
        }

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }

        // 데모 데이터 생성
        function generateDemoData() {
            // 주소 (그리드)
            let addrId = 1;
            for (let row = 0; row < 10; row++) {
                for (let col = 0; col < 20; col++) {
                    addresses.push({
                        id: addrId++,
                        x: col * 500 + 100,
                        y: row * 400 + 100,
                        isJunction: col % 5 === 0
                    });
                }
            }

            // 레인 (주소 연결)
            let laneId = 1;
            for (let addr of addresses) {
                // 오른쪽 연결
                const rightAddr = addresses.find(a =>
                    a.x === addr.x + 500 && a.y === addr.y
                );
                if (rightAddr) {
                    lanes.push({
                        id: laneId++,
                        startX: addr.x,
                        startY: addr.y,
                        endX: rightAddr.x,
                        endY: rightAddr.y
                    });
                }

                // 아래 연결
                const downAddr = addresses.find(a =>
                    a.x === addr.x && a.y === addr.y + 400
                );
                if (downAddr) {
                    lanes.push({
                        id: laneId++,
                        startX: addr.x,
                        startY: addr.y,
                        endX: downAddr.x,
                        endY: downAddr.y
                    });
                }
            }

            // 스테이션
            for (let i = 0; i < 50; i++) {
                const addr = addresses[Math.floor(Math.random() * addresses.length)];
                stations.push({
                    id: i + 1,
                    name: `STN_${String(i + 1).padStart(4, '0')}`,
                    x: addr.x + 50,
                    y: addr.y,
                    hasFoup: Math.random() < 0.3,
                    isAvailable: true
                });
            }

            // 차량
            for (let i = 0; i < 20; i++) {
                const addr = addresses[Math.floor(Math.random() * addresses.length)];
                vehicles.push({
                    id: i + 1,
                    name: `OHT_${String(i + 1).padStart(4, '0')}`,
                    x: addr.x,
                    y: addr.y,
                    state: 'IDLE',
                    hasFoup: Math.random() < 0.2,
                    speed: 0,
                    targetX: null,
                    targetY: null,
                    path: []
                });
            }

            updateStats();
            updateVehicleList();
            addLog('Demo data generated', 'info');
        }

        // 렌더링
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);

            // 레인 그리기
            ctx.strokeStyle = '#1a4080';
            ctx.lineWidth = 3 / scale;
            for (let lane of lanes) {
                ctx.beginPath();
                ctx.moveTo(lane.startX, lane.startY);
                ctx.lineTo(lane.endX, lane.endY);
                ctx.stroke();
            }

            // 주소 그리기
            for (let addr of addresses) {
                ctx.fillStyle = addr.isJunction ? '#ffc107' : '#0f3460';
                ctx.beginPath();
                ctx.arc(addr.x, addr.y, addr.isJunction ? 8 : 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // 스테이션 그리기
            for (let station of stations) {
                ctx.fillStyle = station.hasFoup ? '#ff9800' : '#2196f3';
                ctx.fillRect(station.x - 15, station.y - 15, 30, 30);

                // 이름
                ctx.fillStyle = '#fff';
                ctx.font = `${10 / scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(station.name, station.x, station.y + 30);
            }

            // 차량 그리기
            for (let vehicle of vehicles) {
                // 차량 색상
                let color = '#4caf50'; // IDLE
                if (vehicle.state === 'MOVING') color = '#00d9ff';
                else if (vehicle.state === 'LOADING' || vehicle.state === 'UNLOADING') color = '#ffc107';
                else if (vehicle.state === 'ERROR') color = '#ff5252';

                // 차량 본체
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(vehicle.x, vehicle.y, 20, 0, Math.PI * 2);
                ctx.fill();

                // FOUP 표시
                if (vehicle.hasFoup) {
                    ctx.fillStyle = '#ff9800';
                    ctx.beginPath();
                    ctx.arc(vehicle.x, vehicle.y, 10, 0, Math.PI * 2);
                    ctx.fill();
                }

                // 이름
                ctx.fillStyle = '#fff';
                ctx.font = `${8 / scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(vehicle.name, vehicle.x, vehicle.y - 25);
            }

            ctx.restore();

            requestAnimationFrame(render);
        }

        // 시뮬레이션
        function startSimulation() {
            isRunning = true;
            isPaused = false;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnPause').disabled = false;
            document.getElementById('btnStop').disabled = false;
            addLog('Simulation started', 'success');
            simulationLoop();
        }

        function pauseSimulation() {
            isPaused = !isPaused;
            document.getElementById('btnPause').textContent = isPaused ? 'Resume' : 'Pause';
            addLog(isPaused ? 'Simulation paused' : 'Simulation resumed', 'info');
        }

        function stopSimulation() {
            isRunning = false;
            isPaused = false;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnPause').disabled = true;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('btnPause').textContent = 'Pause';
            addLog('Simulation stopped', 'warning');
        }

        function simulationLoop() {
            if (!isRunning) return;
            if (!isPaused) {
                tick++;
                simTime += 0.1;
                updateSimulation();
                updateUI();
            }
            setTimeout(simulationLoop, 100);
        }

        function updateSimulation() {
            // 차량 이동 시뮬레이션
            for (let vehicle of vehicles) {
                if (vehicle.state === 'MOVING' && vehicle.targetX !== null) {
                    const dx = vehicle.targetX - vehicle.x;
                    const dy = vehicle.targetY - vehicle.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 10) {
                        vehicle.x = vehicle.targetX;
                        vehicle.y = vehicle.targetY;
                        vehicle.targetX = null;
                        vehicle.targetY = null;

                        if (vehicle.path.length > 0) {
                            const next = vehicle.path.shift();
                            vehicle.targetX = next.x;
                            vehicle.targetY = next.y;
                        } else {
                            vehicle.state = Math.random() < 0.5 ? 'LOADING' : 'IDLE';
                            if (vehicle.state === 'IDLE') {
                                addLog(`${vehicle.name} arrived at destination`, 'success');
                            }
                        }
                    } else {
                        const speed = 50; // 이동 속도
                        vehicle.x += (dx / dist) * speed;
                        vehicle.y += (dy / dist) * speed;
                        vehicle.speed = speed;
                    }
                } else if (vehicle.state === 'LOADING') {
                    if (Math.random() < 0.05) {
                        vehicle.hasFoup = true;
                        vehicle.state = 'IDLE';
                        addLog(`${vehicle.name} loaded FOUP`, 'info');
                    }
                } else if (vehicle.state === 'UNLOADING') {
                    if (Math.random() < 0.05) {
                        vehicle.hasFoup = false;
                        vehicle.state = 'IDLE';
                        addLog(`${vehicle.name} unloaded FOUP`, 'info');
                    }
                }
            }
        }

        function updateUI() {
            // 시간 표시
            const hours = Math.floor(simTime / 3600);
            const minutes = Math.floor((simTime % 3600) / 60);
            const seconds = Math.floor(simTime % 60);
            document.getElementById('simTime').textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('tickCount').textContent = tick;

            updateStats();
            updateVehicleList();
        }

        function updateStats() {
            document.getElementById('statVehicles').textContent = vehicles.length;
            document.getElementById('statStations').textContent = stations.length;
            document.getElementById('statActiveJobs').textContent =
                vehicles.filter(v => v.state === 'MOVING').length;
            document.getElementById('statCompletedJobs').textContent =
                Math.floor(tick / 100);
        }

        function updateVehicleList() {
            const list = document.getElementById('vehicleList');
            list.innerHTML = vehicles.slice(0, 10).map(v => `
                <div class="vehicle-item">
                    <div class="vehicle-icon ${v.state.toLowerCase()}">${v.hasFoup ? 'F' : ''}</div>
                    <div class="vehicle-info">
                        <div class="name">${v.name}</div>
                        <div class="status">${v.state} | Speed: ${v.speed.toFixed(0)} m/min</div>
                    </div>
                </div>
            `).join('');
        }

        // 작업 생성
        function createJob() {
            const source = parseInt(document.getElementById('sourceStation').value);
            const dest = parseInt(document.getElementById('destStation').value);
            const priority = document.getElementById('jobPriority').value;

            // 가용 차량 찾기
            const idleVehicle = vehicles.find(v => v.state === 'IDLE' && !v.hasFoup);
            if (!idleVehicle) {
                addLog('No available vehicle for job', 'warning');
                return;
            }

            const sourceStation = stations.find(s => s.id === source);
            const destStation = stations.find(s => s.id === dest);

            if (!sourceStation || !destStation) {
                addLog('Invalid station IDs', 'error');
                return;
            }

            // 경로 생성 (단순화)
            idleVehicle.state = 'MOVING';
            idleVehicle.targetX = sourceStation.x;
            idleVehicle.targetY = sourceStation.y;
            idleVehicle.path = [
                { x: destStation.x, y: destStation.y }
            ];

            addLog(`Job created: ${sourceStation.name} -> ${destStation.name} (${priority})`, 'success');
        }

        // 로그
        function addLog(message, type = 'info') {
            const panel = document.getElementById('logPanel');
            const time = new Date().toLocaleTimeString();
            panel.innerHTML = `<div class="log-entry ${type}">[${time}] ${message}</div>` + panel.innerHTML;

            // 최대 50개 유지
            while (panel.children.length > 50) {
                panel.removeChild(panel.lastChild);
            }
        }

        // 캔버스 드래그
        function startDrag(e) {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        }

        function drag(e) {
            if (!isDragging) return;
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            offsetX += dx;
            offsetY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        }

        function endDrag() {
            isDragging = false;
        }

        function handleZoom(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= delta;
            scale = Math.max(0.02, Math.min(2, scale));
        }

        function zoomIn() {
            scale *= 1.2;
            scale = Math.min(2, scale);
        }

        function zoomOut() {
            scale *= 0.8;
            scale = Math.max(0.02, scale);
        }

        function resetView() {
            scale = 0.1;
            offsetX = 50;
            offsetY = 50;
        }

        // 웹소켓 연결 (서버 실행 시)
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8765');
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.vehicles) vehicles = data.vehicles;
                if (data.stations) stations = data.stations;
                tick = data.tick || tick;
                simTime = data.time || simTime;
                updateUI();
            };
            ws.onclose = () => {
                addLog('WebSocket disconnected', 'warning');
            };
        }

        // 시작
        init();
    </script>
</body>
</html>
